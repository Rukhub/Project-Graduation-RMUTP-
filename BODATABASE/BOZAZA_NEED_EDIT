/**
 * ==========================================
 * ðŸš€ BACKEND FINAL STRUCTURE
 * Assets / Locations / Reports / Check-Logs / Users
 * ==========================================
 */

const express = require('express');
const mysql = require('mysql2');
const cors = require('cors');
const multer = require('multer');
const path = require('path');
const fs = require('fs');

const app = express();

/* ==========================================
 * 1ï¸âƒ£ GLOBAL CONFIG & MIDDLEWARE
 * ========================================== */
app.use(cors());
app.use(express.json());
app.use('/uploads', express.static(path.join(__dirname, 'uploads')));

// create uploads folder
if (!fs.existsSync('./uploads')) {
    fs.mkdirSync('./uploads');
}

/* ==========================================
 * 2ï¸âƒ£ DATABASE CONNECTION
 * ========================================== */
const db = mysql.createConnection({
    host: 'localhost',
    user: 'root',
    password: 'password123',
    database: 'krupandb',
    timezone: '+07:00'
});

db.connect(err => {
    if (err) return console.error('âŒ DB Error:', err);
    console.log('âœ… Database Connected');
});

/* ==========================================
 * 3ï¸âƒ£ FILE UPLOAD (MULTER)
 * ========================================== */
const storage = multer.diskStorage({
    destination: (_, __, cb) => cb(null, 'uploads/'),
    filename: (_, file, cb) =>
        cb(null, Date.now() + path.extname(file.originalname))
});
const upload = multer({ storage });

/* ==========================================
 * 4ï¸âƒ£ AUTH / USERS
 * ========================================== */
app.post('/api/login', (req, res) => {
    const { username, password } = req.body;
    db.query(
        "SELECT * FROM users WHERE username = ? AND password = ?",
        [username, password],
        (err, results) => {
            if (results?.length) res.json({ user: results[0] });
            else res.status(401).json({ message: "à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§" });
        }
    );
});

app.get('/api/users/all', (req, res) => {
    db.query("SELECT * FROM users ORDER BY created_at DESC",
        (err, results) => res.json(results)
    );
});

/* ==========================================
 * 5ï¸âƒ£ LOCATIONS (ROOMS)
 * ========================================== */
app.get('/api/locations', (req, res) => {
    db.query(
        "SELECT * FROM locations ORDER BY floor, room_name",
        (err, results) => res.json(results)
    );
});

app.post('/api/locations', (req, res) => {
    const { room_name, floor } = req.body;
    db.query(
        "INSERT INTO locations (room_name, floor) VALUES (?, ?)",
        [room_name, floor],
        () => res.json({ success: true })
    );
});

app.put('/api/locations/:id', (req, res) => {
    const { room_name, floor } = req.body;
    db.query(
        "UPDATE locations SET room_name = ?, floor = ? WHERE location_id = ?",
        [room_name, floor, req.params.id],
        () => res.json({ success: true })
    );
});

app.delete('/api/locations/:id', (req, res) => {
    db.query(
        "DELETE FROM locations WHERE location_id = ?",
        [req.params.id],
        () => res.json({ success: true })
    );
});

/* ==========================================
 * 6ï¸âƒ£ ASSETS (CRUD)
 * ========================================== */

// à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸„à¸£à¸¸à¸ à¸±à¸“à¸‘à¹Œà¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” (à¹à¸šà¸šà¸ªà¸¡à¸šà¸¹à¸£à¸“à¹Œà¹€à¸žà¸·à¹ˆà¸­à¸£à¸±à¸)
app.get('/api/assets', (req, res) => {
    const sql = `
        SELECT a.*, l.room_name, l.floor,
        -- à¸”à¸¶à¸‡à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¸ªà¸£à¹‰à¸²à¸‡ (à¹€à¸›à¸£à¸µà¸¢à¸šà¹€à¸—à¸µà¸¢à¸šà¸•à¸±à¸§à¹€à¸¥à¸‚à¸•à¸£à¸‡à¹† à¹„à¸”à¹‰à¹€à¸¥à¸¢à¸«à¸¥à¸±à¸‡à¸ˆà¸²à¸à¹à¸à¹‰ DB)
        (SELECT u.fullname FROM users u WHERE u.user_id = a.created_by LIMIT 1) AS created_by_name,
        -- à¸”à¸¶à¸‡à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸¥à¹ˆà¸²à¸ªà¸¸à¸”
        (SELECT u2.fullname FROM check_logs cl 
         JOIN users u2 ON cl.checker_id = u2.user_id
         WHERE cl.asset_id = a.asset_id 
         ORDER BY cl.check_date DESC LIMIT 1) AS checker_name
        FROM assets a
        LEFT JOIN locations l ON a.location_id = l.location_id
        ORDER BY a.created_at DESC
    `;
    db.query(sql, (err, results) => {
        if (err) return res.status(500).json(err);
        res.json(results);
    });
});

// assets by room
app.get('/api/assets/room/:locationId', (req, res) => {
    db.query(
        "SELECT * FROM assets WHERE location_id = ?",
        [req.params.locationId],
        (err, results) => res.json(results)
    );
});

// create asset (à¸£à¸­à¸‡à¸£à¸±à¸šà¸—à¸±à¹‰à¸‡à¹à¸šà¸šà¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¹„à¸Ÿà¸¥à¹Œ à¹à¸¥à¸°à¹à¸šà¸šà¸ªà¹ˆà¸‡ URL à¹à¸¢à¸à¸•à¸²à¸¡à¸—à¸µà¹ˆà¸£à¸±à¸à¸šà¸­à¸)
app.post('/api/assets', upload.single('image'), (req, res) => {
    // à¸£à¸±à¸š created_by à¸ˆà¸²à¸à¸£à¸±à¸ (à¸‹à¸¶à¹ˆà¸‡à¸£à¸±à¸à¸•à¹‰à¸­à¸‡à¸ªà¹ˆà¸‡à¸Šà¸·à¹ˆà¸­ 'Admin Bo' à¸«à¸£à¸·à¸­ email à¸¡à¸²à¹ƒà¸«à¹‰à¹‚à¸š)
    const { asset_id, asset_type, brand_model, location_id, status, created_by, image_url } = req.body;

    let finalImageUrl = image_url || ''; 
    if (req.file) {
        finalImageUrl = `${req.protocol}://${req.get('host')}/uploads/${req.file.filename}`;
    }

    const sql = `
        INSERT INTO assets 
        (asset_id, asset_type, brand_model, location_id, status, image_url, created_by, created_at)
        VALUES (?, ?, ?, ?, ?, ?, ?, NOW())
    `;

    // à¸šà¸±à¸™à¸—à¸¶à¸à¸„à¹ˆà¸² created_by à¸—à¸µà¹ˆà¹„à¸”à¹‰à¸ˆà¸²à¸à¹à¸­à¸› à¸–à¹‰à¸²à¹à¸­à¸›à¹„à¸¡à¹ˆà¸ªà¹ˆà¸‡à¸¡à¸²à¸„à¹ˆà¸­à¸¢à¹ƒà¸Šà¹‰ 'System'
    db.query(
        sql, 
        [asset_id, asset_type, brand_model, location_id, status || 'à¸£à¸­à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š', finalImageUrl, created_by || 'Admin_Bo'], 
        (err, result) => {
            if (err) return res.status(500).json(err);
            res.json({ success: true });
        }
    );
});

// update asset
app.put('/api/assets/:id', upload.single('image'), (req, res) => {
    const { asset_type, brand_model, location_id, status, image_url } = req.body;

    let finalImage = image_url;
    if (req.file) {
        finalImage = `${req.protocol}://${req.get('host')}/uploads/${req.file.filename}`;
    }

    db.query(
        `UPDATE assets SET asset_type=?, brand_model=?, location_id=?, status=?, image_url=? 
         WHERE asset_id=?`,
        [asset_type, brand_model, location_id, status, finalImage, req.params.id],
        () => res.json({ success: true })
    );
});

// â­ à¹à¸à¹‰à¸›à¸±à¸à¸«à¸² 404 POST /api/upload
app.post('/api/upload', upload.single('image'), (req, res) => {
    if (!req.file) return res.status(400).json({ message: "à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¹€à¸¥à¸·à¸­à¸à¸£à¸¹à¸›à¸ à¸²à¸ž" });
    const imageUrl = `${req.protocol}://${req.get('host')}/uploads/${req.file.filename}`;
    res.json({ success: true, image_url: imageUrl });
});

// delete asset
app.delete('/api/assets/:id', (req, res) => {
    db.query(
        "DELETE FROM assets WHERE asset_id = ?",
        [req.params.id],
        () => res.json({ success: true })
    );
});

/* ==========================================
 * 7ï¸âƒ£ REPORTS (à¹à¸ˆà¹‰à¸‡à¸‹à¹ˆà¸­à¸¡) - à¹à¸à¹‰à¹„à¸‚à¸•à¸²à¸¡à¸„à¸³à¹à¸™à¸°à¸™à¸³à¸‚à¸­à¸‡à¸£à¸±à¸
 * ========================================== */
app.post('/api/reports', upload.single('image'), (req, res) => {
    // 1. à¹€à¸žà¸´à¹ˆà¸¡ image_url à¹€à¸‚à¹‰à¸²à¸¡à¸²à¹ƒà¸™à¸•à¸±à¸§à¸£à¸±à¸šà¸„à¹ˆà¸² (Destructuring)
    const { asset_id, reporter_name, fullname, issue_detail, details, image_url } = req.body;

    const reporter = reporter_name || fullname || 'à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸à¸Šà¸·à¹ˆà¸­';
    const detail = issue_detail || details || 'à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸£à¸°à¸šà¸¸à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”';

    // 2. à¸›à¸£à¸±à¸šà¸à¸²à¸£à¸”à¸¶à¸‡ URL à¸£à¸¹à¸›à¸ à¸²à¸žà¹ƒà¸«à¹‰à¸‰à¸¥à¸²à¸”à¸‚à¸¶à¹‰à¸™
    let imageUrl = image_url || ''; 
    if (!imageUrl && req.file) {
        imageUrl = `${req.protocol}://${req.get('host')}/uploads/${req.file.filename}`;
    }

    // 3. à¹€à¸žà¸´à¹ˆà¸¡ Error Handling à¹€à¸žà¸·à¹ˆà¸­à¹€à¸Šà¹‡à¸à¸§à¹ˆà¸²à¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸³à¹€à¸£à¹‡à¸ˆà¹„à¸«à¸¡
    const sql = `INSERT INTO reports (asset_id, reporter_name, issue_detail, image_url, report_date) 
                 VALUES (?, ?, ?, ?, NOW())`;

    db.query(sql, [asset_id, reporter, detail, imageUrl], (err) => {
        if (err) {
            console.error("âŒ à¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ:", err);
            return res.status(500).json({ success: false, message: 'à¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ' });
        }
        console.log(`ðŸ“¢ à¸£à¸±à¸šà¹à¸ˆà¹‰à¸‡à¸‹à¹ˆà¸­à¸¡à¹ƒà¸«à¸¡à¹ˆà¸ˆà¸²à¸: ${reporter}`);
        res.json({ success: true });
    });
});

app.get('/api/assets/:assetId/reports', (req, res) => {
    db.query(
        "SELECT r.*, r.reporter_name AS fullname FROM reports r WHERE r.asset_id = ? ORDER BY r.report_date DESC",
        [req.params.assetId],
        (err, results) => res.json(results)
    );
});

app.get('/api/reports', (req, res) => {
    const sql = `
        SELECT r.*, a.asset_type, a.brand_model, l.room_name,
               (SELECT u.fullname FROM users u WHERE u.username = r.reporter_name OR u.fullname = r.reporter_name LIMIT 1) AS reporter_display_name
        FROM reports r
        JOIN assets a ON r.asset_id = a.asset_id
        LEFT JOIN locations l ON a.location_id = l.location_id
        ORDER BY r.report_date DESC
    `;
    db.query(sql, (err, results) => {
        if (err) return res.status(500).json(err);
        res.json(results);
    });
});

/* ==========================================
 * 8ï¸âƒ£ CHECK LOGS
 * ========================================== */
app.post('/api/check-logs', (req, res) => {
    const { asset_id, checker_id, result_status, remark, image_url } = req.body;

    db.query(
        `INSERT INTO check_logs 
         (asset_id, checker_id, result_status, remark, image_url, check_date)
         VALUES (?, ?, ?, ?, ?, NOW())`,
        [asset_id, checker_id, result_status, remark, image_url],
        () => {
            db.query(
                "UPDATE assets SET status=? WHERE asset_id=?",
                [result_status, asset_id],
                () => res.json({ success: true })
            );
        }
    );
});

// â­ à¹à¸à¹‰à¸›à¸±à¸à¸«à¸² 404 /api/assets/Messi/check-logs
app.get('/api/assets/:assetId/check-logs', (req, res) => {
    const assetId = req.params.assetId;
    // à¹ƒà¸Šà¹‰ SQL à¸„à¹‰à¸™à¸«à¸²à¹à¸šà¸šà¸•à¸£à¸‡à¸•à¸±à¸§à¸«à¸£à¸·à¸­à¹ƒà¸à¸¥à¹‰à¹€à¸„à¸µà¸¢à¸‡à¹€à¸žà¸·à¹ˆà¸­à¸£à¸­à¸‡à¸£à¸±à¸š Messi/MESSI
    const sql = `
        SELECT cl.*, u.fullname 
        FROM check_logs cl 
        JOIN users u ON cl.checker_id = u.user_id 
        WHERE LOWER(cl.asset_id) = LOWER(?) 
        ORDER BY cl.check_date DESC`;
        
    db.query(sql, [assetId], (err, results) => {
        if (err) return res.status(500).json(err);
        res.json(results);
    });
});

// â­ [à¹€à¸žà¸´à¹ˆà¸¡] à¸ªà¸³à¸«à¸£à¸±à¸šà¸¥à¸šà¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¸•à¸£à¸§à¸ˆ (à¸–à¹‰à¸²à¸„à¸µà¸¢à¹Œà¸œà¸´à¸”)
app.delete('/api/check-logs/:id', (req, res) => {
    db.query("DELETE FROM check_logs WHERE log_id = ?", [req.params.id], () => res.json({ success: true }));
});

// à¸¥à¸šà¸£à¸²à¸¢à¸à¸²à¸£à¹à¸ˆà¹‰à¸‡à¸‹à¹ˆà¸­à¸¡ (Delete Report)
app.delete('/api/reports/:id', (req, res) => {
    const reportId = req.params.id;
    db.query("DELETE FROM reports WHERE report_id = ?", [reportId], (err) => {
        if (err) return res.status(500).json(err);
        console.log(`ðŸ—‘ï¸ à¸¥à¸šà¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¹à¸ˆà¹‰à¸‡à¸‹à¹ˆà¸­à¸¡ ID: ${reportId}`);
        res.json({ success: true });
    });
});

// à¸”à¸¶à¸‡à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¸•à¸£à¸§à¸ˆ "à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”" à¸ªà¸³à¸«à¸£à¸±à¸š Admin
app.get('/api/check-logs/all', (req, res) => {
    const sql = `
        SELECT cl.*, u.fullname AS checker_name, a.asset_type, a.brand_model
        FROM check_logs cl
        JOIN users u ON cl.checker_id = u.user_id
        JOIN assets a ON cl.asset_id = a.asset_id
        ORDER BY cl.check_date DESC
    `;
    db.query(sql, (err, results) => {
        if (err) return res.status(500).json(err);
        res.json(results);
    });
});

/* ==========================================
 * 9ï¸âƒ£ DASHBOARD
 * ========================================== */
app.get('/api/dashboard-stats', (req, res) => {
    db.query(
        `SELECT COUNT(*) total,
         SUM(status='à¸›à¸à¸•à¸´') normal,
         SUM(status='à¸Šà¸³à¸£à¸¸à¸”') damaged,
         SUM(status='à¸£à¸­à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š') pending
         FROM assets`,
        (err, results) => res.json(results[0])
    );
});

/* ==========================================
 * ðŸš€ GOOGLE LOGIN SYSTEM
 * ========================================== */
const { OAuth2Client } = require('google-auth-library');

// à¸§à¸²à¸‡ Client ID à¸—à¸µà¹ˆà¹‚à¸šà¸à¹Šà¸­à¸›à¸¡à¸²à¸•à¸£à¸‡à¸™à¸µà¹‰à¹€à¸¥à¸¢à¸„à¸£à¸±à¸š
const CLIENT_ID = '981166009147-bq5unpno2qqgq5gqdqpbvsukes2tp17m.apps.googleusercontent.com';
const client = new OAuth2Client(CLIENT_ID);

app.post('/api/google-login', async (req, res) => {
    const { idToken } = req.body;
    try {
        const ticket = await client.verifyIdToken({
            idToken: idToken,
            audience: CLIENT_ID,
        });
        const payload = ticket.getPayload();
        const { email, name } = payload;

        // ðŸ›¡ï¸ à¸ªà¹ˆà¸§à¸™à¸—à¸µà¹ˆà¹€à¸žà¸´à¹ˆà¸¡à¹€à¸‚à¹‰à¸²à¹„à¸›: à¹€à¸Šà¹‡à¸à¹‚à¸”à¹€à¸¡à¸™à¸­à¸µà¹€à¸¡à¸¥
        if (!email.endsWith('@rmutp.ac.th')) {
            return res.status(403).json({ 
                success: false, 
                message: "à¸‚à¸­à¸­à¸ à¸±à¸¢! à¸£à¸°à¸šà¸šà¸™à¸µà¹‰à¸­à¸™à¸¸à¸à¸²à¸•à¹ƒà¸«à¹‰à¹€à¸‰à¸žà¸²à¸°à¸­à¸µà¹€à¸¡à¸¥ @rmutp.ac.th à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™" 
            });
        }

        // à¸–à¹‰à¸²à¸œà¹ˆà¸²à¸™à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚à¸­à¸µà¹€à¸¡à¸¥à¸¡à¸«à¸²à¸¥à¸±à¸¢à¹à¸¥à¹‰à¸§ à¸„à¹ˆà¸­à¸¢à¹„à¸›à¹€à¸Šà¹‡à¸à¹ƒà¸™ DB à¸•à¹ˆà¸­
        db.query("SELECT * FROM users WHERE username = ?", [email], (err, results) => {
            if (results?.length > 0) {
                res.json({ success: true, user: results[0] });
            } else {
                const newUser = { 
                    username: email, 
                    fullname: name, 
                    role: 'user', 
                    status: 'approved',
                    created_at: new Date()
                };
                db.query("INSERT INTO users SET ?", newUser, (err, result) => {
                    if (err) return res.status(500).json(err);
                    res.json({ success: true, user: { user_id: result.insertId, ...newUser } });
                });
            }
        });
    } catch (error) {
        console.error("âŒ Google Auth Fail:", error);
        res.status(401).json({ success: false, message: "Google Login Failed" });
    }
});

/* ==========================================
 * ðŸ”Ÿ SERVER START
 * ========================================== */
app.listen(3000, () => {
    console.log('ðŸš€ Backend running on port 3000');
});
