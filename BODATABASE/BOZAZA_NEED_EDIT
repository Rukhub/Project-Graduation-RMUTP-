/* ==========================================
 * üöÄ GOOGLE LOGIN SYSTEM
 * ========================================== */
const { OAuth2Client } = require('google-auth-library');

// ‡∏ß‡∏≤‡∏á Client ID ‡∏ó‡∏µ‡πà‡πÇ‡∏ö‡∏Å‡πä‡∏≠‡∏õ‡∏°‡∏≤‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö
const CLIENT_ID = '981166009147-bq5unpno2qqgq5gqdqpbvsukes2tp17m.apps.googleusercontent.com';
const client = new OAuth2Client(CLIENT_ID);

app.post('/api/google-login', async (req, res) => {
    const { idToken } = req.body;
    try {
        const ticket = await client.verifyIdToken({
            idToken: idToken,
            audience: CLIENT_ID,
        });
        const payload = ticket.getPayload();
        const { email, name } = payload;

        // üõ°Ô∏è ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ: ‡πÄ‡∏ä‡πá‡∏Å‡πÇ‡∏î‡πÄ‡∏°‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•
        if (!email.endsWith('@rmutp.ac.th')) {
            return res.status(403).json({ 
                success: false, 
                message: "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢! ‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏≠‡∏µ‡πÄ‡∏°‡∏• @rmutp.ac.th ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô" 
            });
        }

        // ‡∏ñ‡πâ‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏°‡∏´‡∏≤‡∏•‡∏±‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡∏Ñ‡πà‡∏≠‡∏¢‡πÑ‡∏õ‡πÄ‡∏ä‡πá‡∏Å‡πÉ‡∏ô DB ‡∏ï‡πà‡∏≠
        db.query("SELECT * FROM users WHERE username = ?", [email], (err, results) => {
            if (results?.length > 0) {
                res.json({ success: true, user: results[0] });
            } else {
                const newUser = { 
                    username: email, 
                    fullname: name, 
                    role: 'user', 
                    status: 'approved',
                    created_at: new Date()
                };
                db.query("INSERT INTO users SET ?", newUser, (err, result) => {
                    if (err) return res.status(500).json(err);
                    res.json({ success: true, user: { user_id: result.insertId, ...newUser } });
                });
            }
        });
    } catch (error) {
        console.error("‚ùå Google Auth Fail:", error);
        res.status(401).json({ success: false, message: "Google Login Failed" });
    }
});
