/**
 * ==========================================
 * üöÄ BACKEND FINAL STRUCTURE
 * Assets / Locations / Reports / Check-Logs / Users
 * ==========================================
 */
const express = require('express');
const mysql = require('mysql2');
const cors = require('cors');
const multer = require('multer');
const path = require('path');
const fs = require('fs');
const app = express();
/* ==========================================
 * 1Ô∏è‚É£ GLOBAL CONFIG & MIDDLEWARE
 * ========================================== */
app.use(cors());
app.use(express.json());
app.use('/uploads', express.static(path.join(__dirname, 'uploads')));
// create uploads folder
if (!fs.existsSync('./uploads')) {
    fs.mkdirSync('./uploads');
}
/* ==========================================
 * 2Ô∏è‚É£ DATABASE CONNECTION
 * ========================================== */
const db = mysql.createConnection({
    host: 'localhost',
    user: 'root',
    password: 'password123',
    database: 'krupandb',
    timezone: '+07:00'
});
db.connect(err => {
    if (err) return console.error('‚ùå DB Error:', err);
    console.log('‚úÖ Database Connected');
});
/* ==========================================
 * 3Ô∏è‚É£ FILE UPLOAD (MULTER)
 * ========================================== */
const storage = multer.diskStorage({
    destination: (_, __, cb) => cb(null, 'uploads/'),
    filename: (_, file, cb) =>
        cb(null, Date.now() + path.extname(file.originalname))
});
const upload = multer({ storage });
/* ==========================================
 * 4Ô∏è‚É£ AUTH / USERS
 * ========================================== */
app.post('/api/login', (req, res) => {
    const { username, password } = req.body;
    db.query(
        "SELECT * FROM users WHERE username = ? AND password = ?",
        [username, password],
        (err, results) => {
            if (results?.length) res.json({ user: results[0] });
            else res.status(401).json({ message: "‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß" });
        }
    );
});
app.get('/api/users/all', (req, res) => {
    db.query("SELECT * FROM users ORDER BY created_at DESC",
        (err, results) => res.json(results)
    );
});
// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Role)
app.put('/api/users/:id/role', (req, res) => {
    const { role } = req.body; // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ 'admin', 'checker', ‡∏´‡∏£‡∏∑‡∏≠ 'user'
    const userId = req.params.id;
    // üõ°Ô∏è ‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å: ‡πÄ‡∏ä‡πá‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡∏•‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ Admin ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏ô‡πÄ‡∏™‡∏°‡∏≠
    const checkAdminSql = "SELECT COUNT(*) as adminCount FROM users WHERE role = 'admin'";
    
    db.query(checkAdminSql, (err, results) => {
        if (err) return res.status(500).json(err);
        
        const adminCount = results[0].adminCount;
        // ‡∏ñ‡πâ‡∏≤‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô admin ‡∏Ñ‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï
        if (role !== 'admin' && adminCount <= 1) {
            // ‡πÄ‡∏ä‡πá‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡πà‡∏≤‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏î‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏ô‡∏µ‡πà‡∏¢‡πÄ‡∏õ‡πá‡∏ô admin ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡πà‡∏≤
            db.query("SELECT role FROM users WHERE user_id = ?", [userId], (err, userResult) => {
                if (userResult[0].role === 'admin') {
                    return res.status(400).json({ 
                        success: false, 
                        message: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin ‡∏Ñ‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏à‡πâ‡∏≤!" 
                    });
                }
                
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà admin ‡∏Ñ‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ ‡∏Å‡πá‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏Å‡∏ï‡∏¥
                performUpdate();
            });
        } else {
            performUpdate();
        }
        function performUpdate() {
            const updateSql = "UPDATE users SET role = ? WHERE user_id = ?";
            db.query(updateSql, [role, userId], (err) => {
                if (err) return res.status(500).json(err);
                console.log(`üîê ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå User ID: ${userId} ‡πÄ‡∏õ‡πá‡∏ô ${role} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
                res.json({ success: true });
            });
        }
    });
});
// ‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏≠‡∏ö‡πÄ‡∏ô‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤)
app.delete('/api/users/:id', (req, res) => {
    const userId = req.params.id;
    db.query("DELETE FROM users WHERE user_id = ?", [userId], (err) => {
        if (err) return res.status(500).json(err);
        console.log(`üóëÔ∏è ‡∏•‡∏ö User ID: ${userId} ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß`);
        res.json({ success: true });
    });
});
/* ==========================================
 * 5Ô∏è‚É£ LOCATIONS (ROOMS)
 * ========================================== */
app.get('/api/locations', (req, res) => {
    db.query(
        "SELECT * FROM locations ORDER BY floor, room_name",
        (err, results) => res.json(results)
    );
});
app.post('/api/locations', (req, res) => {
    const { room_name, floor } = req.body;
    db.query(
        "INSERT INTO locations (room_name, floor) VALUES (?, ?)",
        [room_name, floor],
        () => res.json({ success: true })
    );
});
app.put('/api/locations/:id', (req, res) => {
    const { room_name, floor } = req.body;
    db.query(
        "UPDATE locations SET room_name = ?, floor = ? WHERE location_id = ?",
        [room_name, floor, req.params.id],
        () => res.json({ success: true })
    );
});
app.delete('/api/locations/:id', (req, res) => {
    db.query(
        "DELETE FROM locations WHERE location_id = ?",
        [req.params.id],
        () => res.json({ success: true })
    );
});
/* ==========================================
 * 6Ô∏è‚É£ ASSETS (CRUD)
 * ========================================== */
app.get('/api/assets', (req, res) => {
    const sql = `
        SELECT a.*, l.room_name, l.floor,
        -- ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á created_by ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ ‡πÉ‡∏´‡πâ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á users
        COALESCE(
            (SELECT u.fullname FROM users u WHERE CAST(u.user_id AS CHAR) = a.created_by OR u.username = a.created_by LIMIT 1),
            a.created_by,
            '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á'
        ) AS created_by_name,
        (SELECT u2.fullname FROM check_logs cl 
         JOIN users u2 ON cl.checker_id = u2.user_id
         WHERE cl.asset_id = a.asset_id 
         ORDER BY cl.check_date DESC LIMIT 1) AS checker_name
        FROM assets a
        LEFT JOIN locations l ON a.location_id = l.location_id
        ORDER BY a.created_at DESC
    `;
    db.query(sql, (err, results) => {
        if (err) return res.status(500).json(err);
        res.json(results);
    });
});
// assets by room
app.get('/api/assets/room/:locationId', (req, res) => {
    db.query(
        "SELECT * FROM assets WHERE location_id = ?",
        [req.params.locationId],
        (err, results) => res.json(results)
    );
});
// create asset (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ö‡∏ö‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå ‡πÅ‡∏•‡∏∞‡πÅ‡∏ö‡∏ö‡∏™‡πà‡∏á URL ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏Å‡∏ö‡∏≠‡∏Å)
app.post('/api/assets', upload.single('image'), (req, res) => {
    // ‡∏£‡∏±‡∏ö created_by ‡∏à‡∏≤‡∏Å‡∏£‡∏±‡∏Å (‡∏ã‡∏∂‡πà‡∏á‡∏£‡∏±‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡∏ä‡∏∑‡πà‡∏≠ 'Admin Bo' ‡∏´‡∏£‡∏∑‡∏≠ email ‡∏°‡∏≤‡πÉ‡∏´‡πâ‡πÇ‡∏ö)
    const { asset_id, asset_type, brand_model, location_id, status, created_by, image_url } = req.body;
    let finalImageUrl = image_url || ''; 
    if (req.file) {
        finalImageUrl = `${req.protocol}://${req.get('host')}/uploads/${req.file.filename}`;
    }
    const sql = `
        INSERT INTO assets 
        (asset_id, asset_type, brand_model, location_id, status, image_url, created_by, created_at)
        VALUES (?, ?, ?, ?, ?, ?, ?, NOW())
    `;
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤ created_by ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡πÅ‡∏≠‡∏õ ‡∏ñ‡πâ‡∏≤‡πÅ‡∏≠‡∏õ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡∏Ñ‡πà‡∏≠‡∏¢‡πÉ‡∏ä‡πâ 'System'
    db.query(
        sql, 
        [asset_id, asset_type, brand_model, location_id, status || '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö', finalImageUrl, created_by || 'Admin_Bo'], 
        (err, result) => {
            if (err) return res.status(500).json(err);
            res.json({ success: true });
        }
    );
});
// update asset (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏≠‡∏≤ created_by ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏°)
app.put('/api/assets/:id', upload.single('image'), (req, res) => {
    const { asset_type, brand_model, location_id, status, image_url } = req.body;
    const assetId = req.params.id;
    let finalImage = image_url;
    if (req.file) {
        finalImage = `${req.protocol}://${req.get('host')}/uploads/${req.file.filename}`;
    }
    // ‡∏•‡∏ö created_by=? ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å SQL ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å‡πÇ‡∏î‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö
    const sql = `
        UPDATE assets 
        SET asset_type=?, brand_model=?, location_id=?, status=?, image_url=?
        WHERE asset_id=?
    `;
    db.query(
        sql,
        [asset_type, brand_model, location_id, status, finalImage, assetId],
        (err, result) => {
            if (err) {
                console.error("‚ùå Update ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", err);
                return res.status(500).json(err);
            }
            console.log(`‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏°) ID: ${assetId} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
            res.json({ success: true });
        }
    );
});
// ‚≠ê ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ 404 POST /api/upload
app.post('/api/upload', upload.single('image'), (req, res) => {
    if (!req.file) return res.status(400).json({ message: "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û" });
    const imageUrl = `${req.protocol}://${req.get('host')}/uploads/${req.file.filename}`;
    res.json({ success: true, image_url: imageUrl });
});
// delete asset
app.delete('/api/assets/:id', (req, res) => {
    db.query(
        "DELETE FROM assets WHERE asset_id = ?",
        [req.params.id],
        () => res.json({ success: true })
    );
});
/* ==========================================
 * 7Ô∏è‚É£ REPORTS (‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°) - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Ç‡∏≠‡∏á‡∏£‡∏±‡∏Å
 * ========================================== */
app.post('/api/reports', upload.single('image'), (req, res) => {
    // 1. ‡πÄ‡∏û‡∏¥‡πà‡∏° image_url ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ (Destructuring)
    const { asset_id, reporter_name, fullname, issue_detail, details, image_url } = req.body;
    const reporter = reporter_name || fullname || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';
    const detail = issue_detail || details || '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î';
    // 2. ‡∏õ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡πâ‡∏â‡∏•‡∏≤‡∏î‡∏Ç‡∏∂‡πâ‡∏ô
    let imageUrl = image_url || ''; 
    if (!imageUrl && req.file) {
        imageUrl = `${req.protocol}://${req.get('host')}/uploads/${req.file.filename}`;
    }
    // 3. ‡πÄ‡∏û‡∏¥‡πà‡∏° Error Handling ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Å‡∏ß‡πà‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÑ‡∏´‡∏°
    const sql = `INSERT INTO reports (asset_id, reporter_name, issue_detail, image_url, report_date) 
                 VALUES (?, ?, ?, ?, NOW())`;
    db.query(sql, [asset_id, reporter, detail, imageUrl], (err) => {
        if (err) {
            console.error("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", err);
            return res.status(500).json({ success: false, message: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' });
        }
        console.log(`üì¢ ‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å: ${reporter}`);
        res.json({ success: true });
    });
});
app.get('/api/assets/:assetId/reports', (req, res) => {
    db.query(
        "SELECT r.*, r.reporter_name AS fullname FROM reports r WHERE r.asset_id = ? ORDER BY r.report_date DESC",
        [req.params.assetId],
        (err, results) => res.json(results)
    );
});
app.get('/api/reports', (req, res) => {
    const sql = `
        SELECT r.*, a.asset_type, a.brand_model, l.room_name,
               (SELECT u.fullname FROM users u WHERE u.username = r.reporter_name OR u.fullname = r.reporter_name LIMIT 1) AS reporter_display_name
        FROM reports r
        JOIN assets a ON r.asset_id = a.asset_id
        LEFT JOIN locations l ON a.location_id = l.location_id
        ORDER BY r.report_date DESC
    `;
    db.query(sql, (err, results) => {
        if (err) return res.status(500).json(err);
        res.json(results);
    });
});
// ‚úÖ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á User ‡∏Ñ‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡πÜ + ‡∏î‡∏∂‡∏á Status ‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢
app.get('/api/reports/user/:name', (req, res) => {
    const userName = req.params.name;
    const sql = `
        SELECT r.*, a.asset_type, a.brand_model, a.status, l.room_name 
        FROM reports r
        JOIN assets a ON r.asset_id = a.asset_id
        LEFT JOIN locations l ON a.location_id = l.location_id
        WHERE r.reporter_name = ? OR (SELECT u.fullname FROM users u WHERE u.fullname = ?) = r.reporter_name
        ORDER BY r.report_date DESC
    `;
    db.query(sql, [userName, userName], (err, results) => {
        if (err) return res.status(500).json(err);
        res.json(results);
    });
});
// ‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á Checker ‡∏Ñ‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡πÜ
app.get('/api/check-logs/checker/:name', (req, res) => {
    const checkerName = req.params.name;
    const sql = `
        SELECT cl.*, u.fullname AS checker_name, a.asset_type, a.brand_model
        FROM check_logs cl
        JOIN users u ON cl.checker_id = u.user_id
        JOIN assets a ON cl.asset_id = a.asset_id
        WHERE u.fullname = ? OR u.username = ?
        ORDER BY cl.check_date DESC
    `;
    db.query(sql, [checkerName, checkerName], (err, results) => {
        if (err) return res.status(500).json(err);
        res.json(results);
    });
});
/* ==========================================
 * 8Ô∏è‚É£ CHECK LOGS
 * ========================================== */
app.post('/api/check-logs', (req, res) => {
    const { asset_id, checker_id, result_status, remark, image_url } = req.body;
    db.query(
        `INSERT INTO check_logs 
         (asset_id, checker_id, result_status, remark, image_url, check_date)
         VALUES (?, ?, ?, ?, ?, NOW())`,
        [asset_id, checker_id, result_status, remark, image_url],
        () => {
            db.query(
                "UPDATE assets SET status=? WHERE asset_id=?",
                [result_status, asset_id],
                () => res.json({ success: true })
            );
        }
    );
});
// ‚≠ê ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ 404 /api/assets/Messi/check-logs
app.get('/api/assets/:assetId/check-logs', (req, res) => {
    const assetId = req.params.assetId;
    // ‡πÉ‡∏ä‡πâ SQL ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö‡∏ï‡∏£‡∏á‡∏ï‡∏±‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Messi/MESSI
    const sql = `
        SELECT cl.*, u.fullname 
        FROM check_logs cl 
        JOIN users u ON cl.checker_id = u.user_id 
        WHERE LOWER(cl.asset_id) = LOWER(?) 
        ORDER BY cl.check_date DESC`;
        
    db.query(sql, [assetId], (err, results) => {
        if (err) return res.status(500).json(err);
        res.json(results);
    });
});
// ‚≠ê [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à (‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏µ‡∏¢‡πå‡∏ú‡∏¥‡∏î)
app.delete('/api/check-logs/:id', (req, res) => {
    db.query("DELETE FROM check_logs WHERE log_id = ?", [req.params.id], () => res.json({ success: true }));
});
// ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° (Delete Report)
app.delete('/api/reports/:id', (req, res) => {
    const reportId = req.params.id;
    db.query("DELETE FROM reports WHERE report_id = ?", [reportId], (err) => {
        if (err) return res.status(500).json(err);
        console.log(`üóëÔ∏è ‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° ID: ${reportId}`);
        res.json({ success: true });
    });
});
// ‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin
app.get('/api/check-logs/all', (req, res) => {
    const sql = `
        SELECT cl.*, u.fullname AS checker_name, a.asset_type, a.brand_model
        FROM check_logs cl
        JOIN users u ON cl.checker_id = u.user_id
        JOIN assets a ON cl.asset_id = a.asset_id
        ORDER BY cl.check_date DESC
    `;
    db.query(sql, (err, results) => {
        if (err) return res.status(500).json(err);
        res.json(results);
    });
});
/* ==========================================
 * 9Ô∏è‚É£ DASHBOARD
 * ========================================== */
app.get('/api/dashboard-stats', (req, res) => {
    db.query(
        `SELECT COUNT(*) total,
         SUM(status='‡∏õ‡∏Å‡∏ï‡∏¥') normal,
         SUM(status='‡∏ä‡∏≥‡∏£‡∏∏‡∏î') damaged,
         SUM(status='‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö') pending
         FROM assets`,
        (err, results) => res.json(results[0])
    );
});
/* ==========================================
 * üöÄ GOOGLE LOGIN SYSTEM
 * ========================================== */
const { OAuth2Client } = require('google-auth-library');
// ‡∏ß‡∏≤‡∏á Client ID ‡∏ó‡∏µ‡πà‡πÇ‡∏ö‡∏Å‡πä‡∏≠‡∏õ‡∏°‡∏≤‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö
const CLIENT_ID = '981166009147-bq5unpno2qqgq5gqdqpbvsukes2tp17m.apps.googleusercontent.com';
const client = new OAuth2Client(CLIENT_ID);
app.post('/api/google-login', async (req, res) => {
    const { idToken } = req.body;
    if (!idToken) return res.status(400).json({ message: "No token" });
    try {
        console.log("üì© Token received, verifying...");
        const ticket = await client.verifyIdToken({
            idToken: idToken,
            audience: CLIENT_ID,
        });
        const payload = ticket.getPayload();
        const { email, name } = payload;
        console.log(`üë§ Google User: ${email}`);
        if (!email.endsWith('@rmutp.ac.th')) {
            return res.status(403).json({ success: false, message: "‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á" });
        }
        // ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á SQL ‡πÅ‡∏ö‡∏ö‡∏î‡∏±‡∏Å Error ‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
        db.query("SELECT * FROM users WHERE username = ?", [email], (err, results) => {
            if (err) {
                console.error("‚ùå SQL SELECT Error:", err.message);
                return res.status(500).json({ message: "DB Error" });
            }
            if (results?.length > 0) {
                console.log("‚úÖ User exists, logging in...");
                res.json({ success: true, user: results[0] });
            } else {
                console.log("üÜï New user, creating account...");
                // ‚úÖ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏û‡∏¥‡πà‡∏° field email ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô object ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ insert ‡∏ú‡πà‡∏≤‡∏ô Not Null
                const newUser = { 
                    username: email,
                    email: email, 
                    fullname: name, 
                    role: 'user',
                    created_at: new Date()
                };
                db.query("INSERT INTO users SET ?", newUser, (insertErr, result) => {
                    if (insertErr) {
                        console.error("‚ùå SQL INSERT Error:", insertErr.message); // ‡∏î‡∏π‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏à‡∏≠‡∏î‡∏≥‡∏ô‡∏∞‡πÇ‡∏ö!
                        return res.status(500).json({ message: "Insert Fail" });
                    }
                    res.json({ success: true, user: { user_id: result.insertId, ...newUser } });
                });
            }
        });
    } catch (error) {
        console.error("‚ùå Google Auth ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", error.message);
        res.status(401).json({ success: false, message: error.message });
    }
});
/* ==========================================
 * üîü SERVER START
 * ========================================== */
app.listen(3000, () => {
    console.log('üöÄ Backend running on port 3000');
});
