/**
 * ==========================================
 * ğŸš€ BACKEND FINAL STRUCTURE (Clean & Fixed)
 * Assets / Locations / Reports / Check-Logs / Users
 * ==========================================
 */
const express = require('express');
const mysql = require('mysql2');
const cors = require('cors');
const multer = require('multer');
const path = require('path');
const fs = require('fs');
const app = express();
/* ==========================================
 * 1ï¸âƒ£ GLOBAL CONFIG & MIDDLEWARE
 * ========================================== */
app.use(cors());
app.use(express.json());
app.use('/uploads', express.static(path.join(__dirname, 'uploads')));
// create uploads folder
if (!fs.existsSync('./uploads')) {
    fs.mkdirSync('./uploads');
}
/* ==========================================
 * 2ï¸âƒ£ DATABASE CONNECTION
 * ========================================== */
const db = mysql.createConnection({
    host: 'localhost',
    user: 'root',
    password: 'password123',
    database: 'krupandb',
    timezone: '+07:00'
});
db.connect(err => {
    if (err) return console.error('âŒ DB Error:', err);
    console.log('âœ… Database Connected');
});
/* ==========================================
 * 3ï¸âƒ£ FILE UPLOAD (MULTER)
 * ========================================== */
const storage = multer.diskStorage({
    destination: (_, __, cb) => cb(null, 'uploads/'),
    filename: (_, file, cb) =>
        cb(null, Date.now() + path.extname(file.originalname))
});
const upload = multer({ storage });
/* ==========================================
 * 4ï¸âƒ£ AUTH / USERS
 * ========================================== */
app.post('/api/login', (req, res) => {
    const { username, password } = req.body;
    db.query(
        "SELECT * FROM users WHERE username = ? AND password = ?",
        [username, password],
        (err, results) => {
            if (results?.length) res.json({ user: results[0] });
            else res.status(401).json({ message: "à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§" });
        }
    );
});
app.get('/api/users/all', (req, res) => {
    db.query("SELECT * FROM users ORDER BY created_at DESC",
        (err, results) => res.json(results)
    );
});
// âœ… à¸”à¸¶à¸‡ User à¸—à¸µà¹ˆà¸£à¸­à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´ (is_approved = 0 à¸«à¸£à¸·à¸­ NULL)
app.get('/api/users/pending', (req, res) => {
    db.query(
        "SELECT * FROM users WHERE is_approved = 0 OR is_approved IS NULL ORDER BY created_at DESC",
        (err, results) => {
            if (err) return res.status(500).json({ success: false, message: err.message });
            res.json(results || []);
        }
    );
});
// âœ… à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´ User à¸„à¸™à¹€à¸”à¸µà¸¢à¸§
app.put('/api/users/:id/approve', (req, res) => {
    const userId = req.params.id;
    db.query(
        "UPDATE users SET is_approved = 1 WHERE user_id = ?",
        [userId],
        (err) => {
            if (err) return res.status(500).json({ success: false, message: err.message });
            console.log(`âœ… à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´ User ID: ${userId} à¸ªà¸³à¹€à¸£à¹‡à¸ˆ`);
            res.json({ success: true, message: 'à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸ªà¸³à¹€à¸£à¹‡à¸ˆ' });
        }
    );
});
// âœ… à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´ User à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸—à¸µà¹ˆà¸£à¸­à¸­à¸¢à¸¹à¹ˆ
app.put('/api/users/approve-all', (req, res) => {
    db.query(
        "UPDATE users SET is_approved = 1 WHERE is_approved = 0 OR is_approved IS NULL",
        (err, result) => {
            if (err) return res.status(500).json({ success: false, message: err.message });
            console.log(`âœ… à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´ User à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” ${result.affectedRows} à¸„à¸™à¸ªà¸³à¹€à¸£à¹‡à¸ˆ`);
            res.json({ success: true, message: `à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¸ˆà¹‰à¸²` });
        }
    );
});
// âœ… à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´ User à¸—à¸µà¹ˆà¹€à¸¥à¸·à¸­à¸ (à¸£à¸±à¸š Array à¸‚à¸­à¸‡ user_ids)
app.put('/api/users/approve-selected', (req, res) => {
    // à¸”à¸±à¸à¸ˆà¸±à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥: à¸šà¸²à¸‡à¸—à¸µà¸£à¸±à¸à¸­à¸²à¸ˆà¸ˆà¸°à¸ªà¹ˆà¸‡à¸¡à¸²à¹ƒà¸™à¸Šà¸·à¹ˆà¸­à¸­à¸·à¹ˆà¸™ à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸ªà¹ˆà¸‡à¸¡à¸²à¹ƒà¸™à¸£à¸¹à¸›à¹à¸šà¸š Array
    const userIds = req.body.userIds || req.body.user_ids;
    if (!userIds || !Array.isArray(userIds) || userIds.length === 0) {
        console.error("âŒ à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¹„à¸”à¹‰à¸£à¸±à¸šà¸ˆà¸²à¸à¸«à¸™à¹‰à¸²à¸šà¹‰à¸²à¸™:", req.body); // à¸à¸´à¸¡à¸à¹Œà¸”à¸¹à¹ƒà¸™à¸ˆà¸­à¸”à¸³à¸§à¹ˆà¸²à¸£à¸±à¸à¸ªà¹ˆà¸‡à¸­à¸°à¹„à¸£à¸¡à¸²
        return res.status(400).json({ success: false, message: 'à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¹€à¸¥à¸·à¸­à¸ User à¸«à¸£à¸·à¸­à¸ªà¹ˆà¸‡à¸£à¸¹à¸›à¹à¸šà¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡' });
    }
    const placeholders = userIds.map(() => '?').join(',');
    db.query(`UPDATE users SET is_approved = 1 WHERE user_id IN (${placeholders})`, userIds, (err, result) => {
        if (err) return res.status(500).json({ success: false, message: err.message });
        console.log(`âœ… à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´à¸à¸¥à¸¸à¹ˆà¸¡à¸ªà¸³à¹€à¸£à¹‡à¸ˆ: ${result.affectedRows} à¸„à¸™`);
        res.json({ success: true, message: `à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´à¸ªà¸³à¹€à¸£à¹‡à¸ˆ ${result.affectedRows}` });
    });
});
// âœ… 1. à¸¥à¸šà¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸‡à¸²à¸™ "à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”" à¸—à¸µà¹ˆà¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸£à¸±à¸šà¸à¸²à¸£à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´ (Clean up à¸„à¸™à¸„à¹‰à¸²à¸‡)
app.delete('/api/users/delete-all-pending', (req, res) => {
    db.query(
        "DELETE FROM users WHERE is_approved = 0 OR is_approved IS NULL",
        (err, result) => {
            if (err) return res.status(500).json({ success: false, message: err.message });
            console.log(`ğŸ—‘ï¸ à¸¥à¸šà¸„à¸™à¸£à¸­à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” ${result.affectedRows} à¸„à¸™à¸ªà¸³à¹€à¸£à¹‡à¸ˆ`);
            res.json({ success: true, message: `à¸¥à¸šà¸„à¸™à¸£à¸­à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¸ˆà¹‰à¸²` });
        }
    );
});
// âœ… 2. à¸¥à¸šà¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸‡à¸²à¸™ "à¹€à¸‰à¸à¸²à¸°à¸—à¸µà¹ˆà¹€à¸¥à¸·à¸­à¸" (Multi-Delete)
// à¸£à¸±à¸à¸•à¹‰à¸­à¸‡à¸ªà¹ˆà¸‡ body à¸¡à¸²à¹€à¸›à¹‡à¸™: { "userIds": [22, 25, 30] }
app.delete('/api/users/delete-selected', (req, res) => {
    const userIds = req.body.userIds || req.body.user_ids;
    if (!userIds || !Array.isArray(userIds) || userIds.length === 0) {
        return res.status(400).json({ success: false, message: 'à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¹€à¸¥à¸·à¸­à¸à¸„à¸™à¸—à¸µà¹ˆà¸ˆà¸°à¸¥à¸šà¸ˆà¹‰à¸²' });
    }
    const placeholders = userIds.map(() => '?').join(',');
    db.query(
        `DELETE FROM users WHERE user_id IN (${placeholders})`,
        userIds,
        (err, result) => {
            if (err) return res.status(500).json({ success: false, message: err.message });
            console.log(`ğŸ—‘ï¸ à¸¥à¸šà¸à¸¥à¸¸à¹ˆà¸¡à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸ªà¸³à¹€à¸£à¹‡à¸ˆ: ${result.affectedRows} à¸„à¸™`);
            res.json({ success: true, message: `à¸¥à¸šà¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸—à¸µà¹ˆà¹€à¸¥à¸·à¸­à¸ ${result.affectedRows} à¸„à¸™à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¸ˆà¹‰à¸²` });
        }
    );
});
// à¸­à¸±à¸›à¹€à¸”à¸•à¸ªà¸´à¸—à¸˜à¸´à¹Œà¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸‡à¸²à¸™ (à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™ Role)
app.put('/api/users/:id/role', (req, res) => {
    const { role } = req.body;
    const userId = req.params.id;
    const checkAdminSql = "SELECT COUNT(*) as adminCount FROM users WHERE role = 'admin'";
    db.query(checkAdminSql, (err, results) => {
        if (err) return res.status(500).json(err);
        const adminCount = results[0].adminCount;
        if (role !== 'admin' && adminCount <= 1) {
            db.query("SELECT role FROM users WHERE user_id = ?", [userId], (err, userResult) => {
                if (userResult[0].role === 'admin') {
                    return res.status(400).json({
                        success: false,
                        message: "à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸¥à¸”à¸ªà¸´à¸—à¸˜à¸´à¹Œ Admin à¸„à¸™à¸ªà¸¸à¸”à¸—à¹‰à¸²à¸¢à¹„à¸”à¹‰à¸ˆà¹‰à¸²!"
                    });
                }
                performUpdate();
            });
        } else {
            performUpdate();
        }
        function performUpdate() {
            const updateSql = "UPDATE users SET role = ? WHERE user_id = ?";
            db.query(updateSql, [role, userId], (err) => {
                if (err) return res.status(500).json(err);
                console.log(`ğŸ” à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸ªà¸´à¸—à¸˜à¸´à¹Œ User ID: ${userId} à¹€à¸›à¹‡à¸™ ${role} à¸ªà¸³à¹€à¸£à¹‡à¸ˆ`);
                res.json({ success: true });
            });
        }
    });
});
app.delete('/api/users/:id', (req, res) => {
    const userId = req.params.id;
    db.query("DELETE FROM users WHERE user_id = ?", [userId], (err) => {
        if (err) return res.status(500).json(err);
        console.log(`ğŸ—‘ï¸ à¸¥à¸š User ID: ${userId} à¸­à¸­à¸à¸ˆà¸²à¸à¸£à¸°à¸šà¸šà¹à¸¥à¹‰à¸§`);
        res.json({ success: true });
    });
});
/* ==========================================
 * 5ï¸âƒ£ LOCATIONS (ROOMS)
 * ========================================== */
app.get('/api/locations', (req, res) => {
    db.query(
        "SELECT * FROM locations ORDER BY floor, room_name",
        (err, results) => res.json(results)
    );
});
app.post('/api/locations', (req, res) => {
    const { room_name, floor } = req.body;
    db.query(
        "INSERT INTO locations (room_name, floor) VALUES (?, ?)",
        [room_name, floor],
        (err, result) => {
            if (err) return res.status(500).json(err);
            res.json({ success: true, location_id: result.insertId });
        }
    );
});
app.put('/api/locations/:id', (req, res) => {
    const { room_name, floor } = req.body;
    db.query(
        "UPDATE locations SET room_name = ?, floor = ? WHERE location_id = ?",
        [room_name, floor, req.params.id],
        () => res.json({ success: true })
    );
});
app.delete('/api/locations/:id', (req, res) => {
    db.query(
        "DELETE FROM locations WHERE location_id = ?",
        [req.params.id],
        () => res.json({ success: true })
    );
});
/* ==========================================
 * 6ï¸âƒ£ ASSETS (CRUD)
 * ========================================== */
app.get('/api/assets', (req, res) => {
    const sql = `
        SELECT a.*, l.room_name, l.floor,
        COALESCE(
            (SELECT u.fullname FROM users u WHERE CAST(u.user_id AS CHAR) = a.created_by OR u.username = a.created_by LIMIT 1),
            a.created_by,
            'à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸à¸œà¸¹à¹‰à¸ªà¸£à¹‰à¸²à¸‡'
        ) AS created_by_name,
        (SELECT u2.fullname FROM check_logs cl 
         JOIN users u2 ON cl.checker_id = u2.user_id
         WHERE cl.asset_id = a.asset_id 
         ORDER BY cl.check_date DESC LIMIT 1) AS checker_name
        FROM assets a
        LEFT JOIN locations l ON a.location_id = l.location_id
        ORDER BY a.created_at DESC
    `;
    db.query(sql, (err, results) => {
        if (err) return res.status(500).json(err);
        res.json(results);
    });
});
app.get('/api/assets/room/:locationId', (req, res) => {
    db.query(
        "SELECT * FROM assets WHERE location_id = ?",
        [req.params.locationId],
        (err, results) => res.json(results)
    );
});
app.post('/api/assets', upload.single('image'), (req, res) => {
    // 1. à¸£à¸±à¸šà¸„à¹ˆà¸²à¸ˆà¸²à¸à¸«à¸™à¹‰à¸²à¸šà¹‰à¸²à¸™ (Destructuring)
    const { asset_id, asset_type, brand_model, location_id, status, created_by, image_url } = req.body;

    // 2. à¸ˆà¸±à¸”à¸à¸²à¸£à¹€à¸£à¸·à¹ˆà¸­à¸‡à¸£à¸¹à¸›à¸ à¸²à¸
    let finalImageUrl = image_url || '';
    if (req.file) {
        finalImageUrl = `${req.protocol}://${req.get('host')}/uploads/${req.file.filename}`;
    }

    // 3. à¸„à¸³à¸ªà¸±à¹ˆà¸‡ SQL (à¹€à¸Šà¹‡à¸à¸Šà¸·à¹ˆà¸­à¸„à¸­à¸¥à¸±à¸¡à¸™à¹Œà¹ƒà¸«à¹‰à¸•à¸£à¸‡à¸à¸±à¸š DB à¹‚à¸šà¸™à¸°)
    const sql = `
        INSERT INTO assets 
        (asset_id, asset_type, brand_model, location_id, status, image_url, created_by, created_at)
        VALUES (?, ?, ?, ?, ?, ?, ?, NOW())
    `;

    // 4. à¸¢à¸´à¸‡ Query (à¸•à¹‰à¸­à¸‡à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™à¸›à¸µà¸à¸à¸²à¸‚à¸­à¸‡ app.post à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™!)
    db.query(
        sql,
        [asset_id, asset_type, brand_model, location_id, status || 'à¸›à¸à¸•à¸´', finalImageUrl, created_by || 'Admin'],
        (err, result) => {
            if (err) {
                console.error("âŒ SQL Error Detail:", err.sqlMessage); // à¸–à¹‰à¸²à¹€à¸à¸´à¹ˆà¸¡à¹„à¸¡à¹ˆà¹„à¸”à¹‰ à¸”à¸¹à¸ˆà¸­à¸”à¸³à¸•à¸£à¸‡à¸™à¸µà¹‰
                return res.status(500).json({ success: false, message: err.sqlMessage });
            }
            res.json({ success: true });
        }
    );
}); // à¸›à¸´à¸”à¸›à¸µà¸à¸à¸² app.post à¸•à¸£à¸‡à¸™à¸µà¹‰
app.put('/api/assets/:id', upload.single('image'), (req, res) => {
    const { asset_type, brand_model, location_id, status, image_url } = req.body;
    const assetId = req.params.id;
    let finalImage = image_url;
    if (req.file) {
        finalImage = `${req.protocol}://${req.get('host')}/uploads/${req.file.filename}`;
    }
    const sql = `
        UPDATE assets 
        SET asset_type=?, brand_model=?, location_id=?, status=?, image_url=?
        WHERE asset_id=?
    `;
    db.query(
        sql,
        [asset_type, brand_model, location_id, status, finalImage, assetId],
        (err, result) => {
            if (err) {
                console.error("âŒ Update à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§:", err);
                return res.status(500).json(err);
            }
            console.log(`âœ… à¸­à¸±à¸›à¹€à¸”à¸•à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ (à¸£à¸±à¸à¸©à¸²à¸œà¸¹à¹‰à¸ªà¸£à¹‰à¸²à¸‡à¹€à¸”à¸´à¸¡) ID: ${assetId} à¸ªà¸³à¹€à¸£à¹‡à¸ˆ`);
            res.json({ success: true });
        }
    );
});
app.post('/api/upload', upload.single('image'), (req, res) => {
    if (!req.file) return res.status(400).json({ message: "à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¹€à¸¥à¸·à¸­à¸à¸£à¸¹à¸›à¸ à¸²à¸" });
    const imageUrl = `${req.protocol}://${req.get('host')}/uploads/${req.file.filename}`;
    res.json({ success: true, image_url: imageUrl });
});
app.delete('/api/assets/:id', (req, res) => {
    db.query(
        "DELETE FROM assets WHERE asset_id = ?",
        [req.params.id],
        () => res.json({ success: true })
    );
});
/* ==========================================
 * 6.1ï¸âƒ£ ASSET MOVEMENT (à¸¢à¹‰à¸²à¸¢à¸«à¹‰à¸­à¸‡)
 * ========================================== */

// âœ… 1. à¸¢à¹‰à¸²à¸¢à¸«à¹‰à¸­à¸‡à¸—à¸µà¸¥à¸°à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡
// à¸£à¸±à¸à¸•à¹‰à¸­à¸‡à¸¢à¸´à¸‡à¸¡à¸²à¸—à¸µà¹ˆ: PUT /api/assets/move
// Body: { "asset_id": "NADECH", "new_location_id": 5 }
app.put('/api/assets/move', (req, res) => {
    const { asset_id, new_location_id } = req.body;

    if (!asset_id || !new_location_id) {
        return res.status(400).json({ success: false, message: "à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸¡à¹ˆà¸„à¸£à¸šà¸™à¸°à¸ˆà¹Šà¸°" });
    }

    const sql = "UPDATE assets SET location_id = ? WHERE asset_id = ?";
    db.query(sql, [new_location_id, asset_id], (err, result) => {
        if (err) {
            console.error("âŒ à¸¢à¹‰à¸²à¸¢à¸«à¹‰à¸­à¸‡à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§:", err.sqlMessage);
            return res.status(500).json({ success: false, message: err.sqlMessage });
        }
        console.log(`ğŸ“¦ à¸¢à¹‰à¸²à¸¢à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡ ${asset_id} à¹„à¸›à¸«à¹‰à¸­à¸‡ ID: ${new_location_id} à¹à¸¥à¹‰à¸§`);
        res.json({ success: true, message: "à¸¢à¹‰à¸²à¸¢à¸«à¹‰à¸­à¸‡à¸ªà¸³à¹€à¸£à¹‡à¸ˆà¹à¸¥à¹‰à¸§à¸ˆà¹‰à¸²" });
    });
});

// âœ… 2. à¸¢à¹‰à¸²à¸¢à¸«à¹‰à¸­à¸‡à¹€à¸›à¹‡à¸™à¸à¸¥à¸¸à¹ˆà¸¡ (à¸¢à¸à¸à¸§à¸à¸¢à¹‰à¸²à¸¢à¸«à¹‰à¸­à¸‡)
// Body: { "assetIds": ["A1", "A2"], "new_location_id": 5 }
app.put('/api/assets/move-selected', (req, res) => {
    const { assetIds, new_location_id } = req.body;

    console.log('ğŸ“¦ === MOVE DEBUG ===');
    console.log('ğŸ“¦ Received assetIds:', assetIds);
    console.log('ğŸ“¦ Received new_location_id:', new_location_id);

    if (!assetIds || !Array.isArray(assetIds) || !new_location_id) {
        return res.status(400).json({ success: false, message: "à¹€à¸¥à¸·à¸­à¸à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¹à¸¥à¸°à¸«à¹‰à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆà¸”à¹‰à¸§à¸¢à¸™à¸°à¸ˆà¹Šà¸°" });
    }

    const placeholders = assetIds.map(() => '?').join(',');
    const sql = `UPDATE assets SET location_id = ? WHERE asset_id IN (${placeholders})`;

    console.log('ğŸ“¦ SQL Query:', sql);
    console.log('ğŸ“¦ SQL Params:', [new_location_id, ...assetIds]);

    db.query(sql, [new_location_id, ...assetIds], (err, result) => {
        if (err) {
            console.error('âŒ SQL Error:', err);
            return res.status(500).json(err);
        }

        console.log('ğŸ“¦ SQL Result:', result);
        console.log('ğŸ“¦ Rows affected:', result.affectedRows);
        console.log('ğŸ“¦ Changed rows:', result.changedRows);

        console.log(`ğŸ“¦ à¸¢à¹‰à¸²à¸¢à¸à¸¥à¸¸à¹ˆà¸¡à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡ ${result.affectedRows} à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¹„à¸›à¸«à¹‰à¸­à¸‡ ID: ${new_location_id}`);
        res.json({ success: true, message: `à¸¢à¹‰à¸²à¸¢à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” ${result.affectedRows} à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!` });
    });
});
app.post('/api/reports', upload.single('image'), (req, res) => {
    const { asset_id, reporter_name, fullname, issue_detail, details, image_url } = req.body;
    const reporter = reporter_name || fullname || 'à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸à¸Šà¸·à¹ˆà¸­';
    const detail = issue_detail || details || 'à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸£à¸°à¸šà¸¸à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”';
    let imageUrl = image_url || '';
    if (!imageUrl && req.file) {
        imageUrl = `${req.protocol}://${req.get('host')}/uploads/${req.file.filename}`;
    }
    // â­ [FIX] à¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸–à¸²à¸™à¸° 'à¸£à¸­à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£' (à¸•à¸²à¸¡ ENUM à¹ƒà¸™ DB) à¸¥à¸‡à¹ƒà¸™ Report à¹€à¸ªà¸¡à¸­
    const sql = `INSERT INTO reports (asset_id, reporter_name, issue_detail, image_url, report_date, status) 
                 VALUES (?, ?, ?, ?, NOW(), 'à¸£à¸­à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£')`;
    db.query(sql, [asset_id, reporter, detail, imageUrl], (err) => {
        if (err) {
            console.error("âŒ à¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ:", err);
            return res.status(500).json({ success: false, message: 'à¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ' });
        }
        console.log(`ğŸ“¢ à¸£à¸±à¸šà¹à¸ˆà¹‰à¸‡à¸‹à¹ˆà¸­à¸¡à¹ƒà¸«à¸¡à¹ˆà¸ˆà¸²à¸: ${reporter}`);
        res.json({ success: true });
    });
});
app.get('/api/assets/:assetId/reports', (req, res) => {
    db.query(
        "SELECT r.*, r.reporter_name AS fullname FROM reports r WHERE r.asset_id = ? ORDER BY r.report_date DESC",
        [req.params.assetId],
        (err, results) => res.json(results)
    );
});
app.get('/api/reports', (req, res) => {
    const sql = `
        SELECT r.*, a.asset_type, a.brand_model, l.room_name,
               r.status AS report_status, 
               a.status AS asset_current_status
        FROM reports r
        JOIN assets a ON r.asset_id = a.asset_id
        LEFT JOIN locations l ON a.location_id = l.location_id
        ORDER BY r.report_date DESC
    `;
    db.query(sql, (err, results) => {
        if (err) return res.status(500).json(err);
        res.json(results);
    });
});
// âœ… [FIX] à¸”à¸¶à¸‡à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¸£à¸²à¸¢à¸‡à¸²à¸™ -> à¹ƒà¸Šà¹‰ r.status (à¸ªà¸–à¸²à¸™à¸°à¹ƒà¸™à¸­à¸”à¸µà¸•) à¹à¸—à¸™ a.status (à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™)
app.get('/api/reports/user/:name', (req, res) => {
    const userName = req.params.name;
    const sql = `
        SELECT r.*, a.asset_type, a.brand_model, r.status, l.room_name, a.status AS asset_current_status 
        FROM reports r
        JOIN assets a ON r.asset_id = a.asset_id
        LEFT JOIN locations l ON a.location_id = l.location_id
        WHERE r.reporter_name = ? OR (SELECT u.fullname FROM users u WHERE u.fullname = ?) = r.reporter_name
        ORDER BY r.report_date DESC
    `;
    db.query(sql, [userName, userName], (err, results) => {
        if (err) return res.status(500).json(err);
        res.json(results);
    });
});
app.get('/api/check-logs/checker/:name', (req, res) => {
    const checkerName = req.params.name;
    const sql = `
        SELECT cl.*, u.fullname AS checker_name, a.asset_type, a.brand_model
        FROM check_logs cl
        JOIN users u ON cl.checker_id = u.user_id
        JOIN assets a ON cl.asset_id = a.asset_id
        WHERE u.fullname = ? OR u.username = ?
        ORDER BY cl.check_date DESC
    `;
    db.query(sql, [checkerName, checkerName], (err, results) => {
        if (err) return res.status(500).json(err);
        res.json(results);
    });
});
/* ==========================================
 * 8ï¸âƒ£ CHECK LOGS (à¸•à¸£à¸§à¸ˆà¸‹à¹ˆà¸­à¸¡)
 * ========================================== */
app.post('/api/check-logs', (req, res) => {
    const { asset_id, checker_id, result_status, remark, image_url } = req.body;
    db.query(
        `INSERT INTO check_logs 
         (asset_id, checker_id, result_status, remark, image_url, check_date)
         VALUES (?, ?, ?, ?, ?, NOW())`,
        [asset_id, checker_id, result_status, remark, image_url],
        () => {
            // 1. à¸­à¸±à¸›à¹€à¸”à¸•à¸ªà¸–à¸²à¸™à¸°à¸—à¸µà¹ˆà¸•à¸±à¸§à¸­à¸¸à¸›à¸à¸£à¸“à¹Œ
            db.query(
                "UPDATE assets SET status=? WHERE asset_id=?",
                [result_status, asset_id],
                () => {
                    // â­ [FIX] à¸–à¹‰à¸²à¸‹à¹ˆà¸­à¸¡à¹€à¸ªà¸£à¹‡à¸ˆ à¹ƒà¸«à¹‰à¹„à¸›à¸›à¸´à¸”à¸ˆà¹Šà¸­à¸šà¹ƒà¸™ Reports à¸”à¹‰à¸§à¸¢!
                    if (result_status === 'à¸›à¸à¸•à¸´' || result_status === 'à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¹„à¸”à¹‰') {
                        db.query(
                            "UPDATE reports SET status='à¸‹à¹ˆà¸­à¸¡à¹€à¸ªà¸£à¹‡à¸ˆà¹à¸¥à¹‰à¸§' WHERE asset_id=? AND status='à¸£à¸­à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£'",
                            [asset_id]
                        );
                    }
                    res.json({ success: true });
                }
            );
        }
    );
});
app.get('/api/assets/:assetId/check-logs', (req, res) => {
    const assetId = req.params.assetId;
    const sql = `
        SELECT cl.*, u.fullname 
        FROM check_logs cl 
        JOIN users u ON cl.checker_id = u.user_id 
        WHERE LOWER(cl.asset_id) = LOWER(?) 
        ORDER BY cl.check_date DESC`;
    db.query(sql, [assetId], (err, results) => {
        if (err) return res.status(500).json(err);
        res.json(results);
    });
});
app.delete('/api/check-logs/:id', (req, res) => {
    db.query("DELETE FROM check_logs WHERE log_id = ?", [req.params.id], () => res.json({ success: true }));
});
app.delete('/api/reports/:id', (req, res) => {
    const reportId = req.params.id;
    db.query("DELETE FROM reports WHERE report_id = ?", [reportId], (err) => {
        if (err) return res.status(500).json(err);
        console.log(`ğŸ—‘ï¸ à¸¥à¸šà¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¹à¸ˆà¹‰à¸‡à¸‹à¹ˆà¸­à¸¡ ID: ${reportId}`);
        res.json({ success: true });
    });
});
app.get('/api/check-logs/all', (req, res) => {
    const sql = `
        SELECT cl.*, u.fullname AS checker_name, a.asset_type, a.brand_model
        FROM check_logs cl
        JOIN users u ON cl.checker_id = u.user_id
        JOIN assets a ON cl.asset_id = a.asset_id
        ORDER BY cl.check_date DESC
    `;
    db.query(sql, (err, results) => {
        if (err) return res.status(500).json(err);
        res.json(results);
    });
});
/* ==========================================
 * 9ï¸âƒ£ DASHBOARD
 * ========================================== */
app.get('/api/dashboard-stats', (req, res) => {
    db.query(
        `SELECT COUNT(*) total,
         SUM(status='à¸›à¸à¸•à¸´') normal,
         SUM(status='à¸Šà¸³à¸£à¸¸à¸”') damaged,
         SUM(status='à¸£à¸­à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š') pending
         FROM assets`,
        (err, results) => res.json(results[0])
    );
});
/* ==========================================
 * ğŸš€ GOOGLE LOGIN SYSTEM
 * ========================================== */
const { OAuth2Client } = require('google-auth-library');
const CLIENT_ID = '981166009147-bq5unpno2qqgq5gqdqpbvsukes2tp17m.apps.googleusercontent.com';
const client = new OAuth2Client(CLIENT_ID);
app.post('/api/google-login', async (req, res) => {
    const { idToken } = req.body;
    if (!idToken) return res.status(400).json({ message: "No token" });
    try {
        console.log("ğŸ“© Token received, verifying...");
        const ticket = await client.verifyIdToken({
            idToken: idToken,
            audience: CLIENT_ID,
        });
        const payload = ticket.getPayload();
        // â­ [FIX] à¸”à¸¶à¸‡ sub (google_id) à¹à¸¥à¸° picture à¸¡à¸²à¹ƒà¸Šà¹‰à¸”à¹‰à¸§à¸¢
        const { email, name, sub, picture } = payload;
        console.log(`ğŸ‘¤ Google User: ${email}`);
        if (!email.endsWith('@rmutp.ac.th')) {
            return res.status(403).json({ success: false, message: "à¸­à¸µà¹€à¸¡à¸¥à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡" });
        }
        db.query("SELECT * FROM users WHERE username = ?", [email], (err, results) => {
            if (err) {
                console.error("âŒ SQL SELECT Error:", err.message);
                return res.status(500).json({ message: "DB Error" });
            }
            if (results?.length > 0) {
                console.log("âœ… User exists, logging in...");
                res.json({ success: true, user: results[0] });
            } else {
                // â­ User à¹ƒà¸«à¸¡à¹ˆ = à¸ªà¸£à¹‰à¸²à¸‡à¹‚à¸”à¸¢ is_approved = 0 (à¸•à¹‰à¸­à¸‡à¸£à¸­ Admin à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´!)
                console.log("ğŸ†• New user, creating account (pending approval)...");
                const newUser = {
                    username: email,
                    email: email,
                    fullname: name,
                    google_id: sub,
                    photo_url: picture,
                    role: 'user',
                    is_approved: 0,  // â­ à¸•à¹‰à¸­à¸‡à¸£à¸­ Admin à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´à¸à¹ˆà¸­à¸™à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¹„à¸”à¹‰!
                    created_at: new Date()
                };
                db.query("INSERT INTO users SET ?", newUser, (insertErr, result) => {
                    if (insertErr) {
                        console.error("âŒ SQL INSERT Error:", insertErr.message);
                        return res.status(500).json({ message: "Insert Fail" });
                    }
                    // â­ [FIX] à¸ªà¹ˆà¸‡à¹à¸„à¹ˆ user_id à¹„à¸¡à¹ˆà¸ªà¹ˆà¸‡ user object à¹€à¸à¸·à¹ˆà¸­à¹ƒà¸«à¹‰ Frontend à¸£à¸¹à¹‰à¸§à¹ˆà¸²à¸•à¹‰à¸­à¸‡à¸£à¸­à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´
                    res.json({
                        success: true,
                        user_id: result.insertId,
                        message: "à¸šà¸±à¸à¸Šà¸µà¸‚à¸­à¸‡à¸„à¸¸à¸“à¸à¸³à¸¥à¸±à¸‡à¸£à¸­à¸à¸²à¸£à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´"
                    });
                });
            }
        });
    } catch (error) {
        console.error("âŒ Google Auth à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§:", error.message);
        res.status(401).json({ success: false, message: error.message });
    }
});
/* ==========================================
 * ğŸ”Ÿ SERVER START
 * ========================================== */
app.listen(3000, () => {
    console.log('ğŸš€ Backend running on port 3000');
});
